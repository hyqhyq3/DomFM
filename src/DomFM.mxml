<?xml version="1.0" encoding="utf-8"?>
<s:WindowedApplication xmlns:fx="http://ns.adobe.com/mxml/2009"
					   xmlns:s="library://ns.adobe.com/flex/spark"
					   xmlns:mx="library://ns.adobe.com/flex/mx" showStatusBar="false"
					   width="420" height="185" backgroundColor="#CFCFCF" initialize="windowedapplication1_initializeHandler(event)">
	<fx:Style source="style.css"/>
	<fx:Script>
		<![CDATA[
			import com.domlib.domFM.action.ID3Parser;
			import com.domlib.domFM.action.Player;
			import com.domlib.domFM.data.ID3Tag;
			import com.domlib.domFM.events.ID3Event;
			import com.domlib.domFM.events.PlayEvent;
			import com.domlib.domFM.utils.FileUtil;
			import com.domlib.domFM.utils.SQL;
			import com.domlib.domFM.utils.StringUtil;
			
			import mx.charts.AreaChart;
			import mx.events.FlexEvent;
			
			
			protected function windowedapplication1_initializeHandler(event:FlexEvent):void
			{
				this.nativeApplication.addEventListener(Event.EXITING,onExiting);
			}
			/**
			 * 应用程序退出
			 */	
			protected function onExiting(event:Event):void
			{
				if(player)
				{
					player.exit();
				}
				if(id3Parser)
					id3Parser.exit();
			}
			
			private var player:Player;
			/**
			 * 播放下一首
			 */	
			private function playNext():void
			{
				if(!player)
				{
					player = new Player();
					player.addEventListener(PlayEvent.PLAY_COMPLETE,onPlayComp);
					player.addEventListener(PlayEvent.PLAY_PROGRESS,onPlayProgress);
				}
				var song:Object = getSongByRandom();
				if(song&&song.url)
				{
					player.playSong(song.url);
					titleLabel.text = song.title+" - "+song.artist;
					nativeWindow.title = song.title+" - DomFM";
					timeLabel.text = "00:00";
				}
			}
			
			/**
			 * 获取一条音乐记录
			 */	
			private function getSongByRandom():Object
			{
				var result:Array = sql.execute("select  Min(count) as count From  song");
				var minCount:Number = Number(result[0].count);
				if(isNaN(minCount))
					minCount = 0;
				result = sql.execute("select * from song where count="+minCount+" order by random() limit 1;");
				if(result)
					return result[0];
				return null;
			}
			/**
			 * 播放进度
			 */	
			private function onPlayProgress(event:PlayEvent):void
			{
				timeLabel.text = StringUtil.toTimeString(event.palyedTime);
			}
			/**
			 * 一首歌播放完成
			 */	
			private function onPlayComp(event:PlayEvent):void
			{
				sql.execute("update song set count = count+1 where url='"+SQL.escape(event.url)+"';");
				playNext();
			}
			/**
			 * 跳过按钮点击
			 */	
			protected function skipBT_clickHandler(event:MouseEvent):void
			{
				playNext();
			}
			/**
			 * id3解析器
			 */	
			private var id3Parser:ID3Parser;
			/**
			 * 添加按钮点击
			 */	
			protected function addBtn_clickHandler(event:MouseEvent):void
			{
				FileUtil.browseForOpen(function(file:File):void{
					var list:Array = FileUtil.search(file.nativePath,null,filterFunc);
					var urlList:Array = [];
					for each(var file:File in list)
					{
						urlList.push(file.nativePath);
					}
					if(!id3Parser)
					{
						id3Parser = new ID3Parser;
						id3Parser.addEventListener(ID3Event.GET_ONE_INFO,onGetMusicInfo);
					}
					id3Parser.parse(urlList);
				},3);
			}
			
			private var sql:SQL = new SQL("music.db");
			/**
			 * 插入一条音乐记录到数据库
			 */	
			private function onGetMusicInfo(event:ID3Event):void
			{
				var result:Array = sql.execute("select title from song where url='"+SQL.escape(event.url)+"'");
				if(result&&result.length>0)
					return;
				var id3:ID3Tag = event.tagInfo;
				if(!id3.title)
				{
					id3.title = FileUtil.getFileName(event.url);
				}
				var type:String = FileUtil.getExtension(event.url);
				sql.execute("insert into song (title,artist,url,type,favor,count) values('"+
					SQL.escape(id3.title)+"','"+SQL.escape(id3.artist)+"','"+SQL.escape(event.url)+"','"+
					SQL.escape(type)+"',0,0);");
				trace(id3.title,id3.artist);
			}
			
			/**
			 * 文件过滤回调函数
			 */	
			private function filterFunc(file:File):Boolean
			{
				if(file.isDirectory)
					return true;
				if(file.extension==null)
					return false;
				var extension:String = file.extension.toLowerCase();
				if(extension=="mp3"||extension=="m4a"||extension=="wma")
					return true;
				return false;
			}
			
		]]>
	</fx:Script>
	<fx:Declarations>
	</fx:Declarations>
	<s:Image id="cover" x="33" y="33" width="120" height="120" scaleMode="zoom"/>
	<s:Group x="180" y="55" width="215" height="45">
		<s:Rect width="100%" height="100%">
			<s:fill>
				<s:SolidColor color="#ddeee1"/>
			</s:fill>
		</s:Rect>
		<s:Label id="titleLabel" x="8" y="27" color="#666666" fontWeight="normal"/>
		<s:Label id="timeLabel" x="8" y="5" color="#666666" fontWeight="bold" text="00:00"/>
	</s:Group>
	<s:Button id="likeBT" x="200" y="115" width="45" height="45" label="喜欢"/>
	<s:Button id="skipBT" x="333" y="115" width="45" height="45" label="跳过" click="skipBT_clickHandler(event)"/>
	<s:Button id="banBT" x="267" y="115" width="45" height="45" label="垃圾"/>
	<s:Button x="364" y="10" width="46" label="添加" click="addBtn_clickHandler(event)"/>
</s:WindowedApplication>
